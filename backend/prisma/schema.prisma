// Prisma Schema for XzityDispatch

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DRIVER
  CUSTOMER
}

// UPDATED VehicleType ENUM: BIKE -> DELIVERY, added WATER_TRUCK
enum VehicleType {
  CAR
  DELIVERY
  TUKTUK
  TRUCK
  WATER_TRUCK
}

enum RideStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model User {
  id               Int             @id @default(autoincrement())
  name             String
  phone            String          @unique
  email            String?         @unique
  password         String
  role             Role
  vehicleType      VehicleType?
  isBusy           Boolean         @default(false)
  ridesAsDriver    Ride[]          @relation("DriverRides")
  ridesAsCustomer  Ride[]          @relation("CustomerRides")
  verificationCode String?
  status           String          @default("PENDING")
  trustedDevices   TrustedDevice[]
}

model Ride {
  id          Int         @id @default(autoincrement())
  customer    User        @relation("CustomerRides", fields: [customerId], references: [id])
  customerId  Int
  driver      User?       @relation("DriverRides", fields: [driverId], references: [id])
  driverId    Int?
  originLat   Float
  originLng   Float
  destLat     Float
  destLng     Float
  requestedAt DateTime    @default(now())
  acceptedAt  DateTime?
  startedAt   DateTime?   // <--- Track when ride goes IN_PROGRESS
  completedAt DateTime?   // <--- Track when ride is COMPLETED (optional, but recommended)
  cancelledAt DateTime?   // <--- Track when ride is CANCELLED (optional)
  status      RideStatus  @default(PENDING)
  vehicleType VehicleType
  rating      Int?        // Customer's rating for the driver (1-5)
  feedback    String?     // Optional feedback from customer
}

model TrustedDevice {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  deviceId  String
  addedAt   DateTime @default(now())

  @@unique([userId, deviceId])
}